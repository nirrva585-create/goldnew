<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>XAUUSD • Real-Time Live</title>
  <style>
    :root {
      --bg: #0a0a0a;
      --card: #111111;
      --text: #e8e8e8;
      --gold: #ffd700;
      --border: #2a2a2a;
      --green: #00cc77;
      --red: #ff5555;
      --gray: #888888;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 16px 12px;
      line-height: 1.5;
    }
    .container { max-width: 1100px; margin: 0 auto; }
    header { text-align: center; margin-bottom: 24px; }
    h1 { color: var(--gold); font-size: 2.4rem; margin-bottom: 8px; }
    #price { font-size: 4rem; font-weight: 800; text-align: center; margin: 16px 0; letter-spacing: -2px; }
    #status { text-align: center; font-size: 1.1rem; margin: 8px 0; color: var(--gray); }
    .signal {
      font-size: 2.8rem;
      font-weight: 800;
      text-align: center;
      padding: 24px;
      border-radius: 16px;
      margin: 0 auto 32px;
      max-width: 600px;
      border: 4px solid;
      transition: all 0.3s;
      text-transform: uppercase;
    }
    .buy  { color: var(--green); border-color: var(--green); background: rgba(0,204,119,0.12); }
    .sell { color: var(--red);   border-color: var(--red);   background: rgba(255,85,85,0.12); }
    .neutral { color: #999; border-color: #444; background: #111; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap: 24px; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
    }
    .card h3 { color: var(--gold); margin-bottom: 16px; font-size: 1.4rem; }
    .stat-row { display: flex; justify-content: space-between; margin: 12px 0; font-size: 1.15rem; }
    .stat-label { color: var(--gray); }
    input, button {
      width: 100%;
      padding: 14px;
      margin: 12px 0;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #1a1a1a;
      color: white;
      font-size: 1.1rem;
    }
    button {
      background: var(--gold);
      color: black;
      font-weight: bold;
      cursor: pointer;
      border: none;
    }
    .controls { text-align: center; margin: 40px 0; }
    .controls button { padding: 14px 32px; font-size: 1.2rem; margin: 0 16px; }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>XAUUSD Real-Time</h1>
  </header>

  <div id="price">--.--</div>
  <div id="status">Connecting to real-time feed…</div>

  <div id="signal" class="signal neutral">NO SIGNAL</div>

  <div class="grid">
    <div class="card">
      <h3>Market Data</h3>
      <div class="stat-row"><span class="stat-label">Price</span><span><b id="cur">--</b></span></div>
      <div class="stat-row"><span class="stat-label">High / Low</span><span><b id="high">--</b> / <b id="low">--</b></span></div>
      <div class="stat-row"><span class="stat-label">Change %</span><span><b id="change">--</b></span></div>
    </div>

    <div class="card">
      <h3>Indicators</h3>
      <div class="stat-row"><span class="stat-label">ADX(14)</span><span><b id="adx">--</b></span></div>
      <div class="stat-row"><span class="stat-label">ATR(14)</span><span><b id="atr">--</b></span></div>
      <div class="stat-row"><span class="stat-label">RSI(14)</span><span><b id="rsi">--</b></span></div>
      <div class="stat-row"><span class="stat-label">EMA(20)</span><span><b id="ema20">--</b></span></div>
      <div class="stat-row"><span class="stat-label">MACD</span><span><b id="macd">--</b></span></div>
    </div>

    <div class="card">
      <h3>Trade Levels</h3>
      <div id="buy-tp" style="margin:16px 0; min-height:60px; font-size:1.2rem;">—</div>
      <div id="sell-tp" style="min-height:60px; font-size:1.2rem;">—</div>
    </div>

    <div class="card">
      <h3>Risk Calculator</h3>
      <input id="acc" type="number" value="10000" placeholder="Account ($)">
      <input id="risk" type="number" value="1" step="0.1" placeholder="Risk %">
      <button onclick="calcSize()">Calculate Size</button>
      <div id="size" style="margin-top:20px; font-weight:bold; font-size:1.2rem;">—</div>
    </div>
  </div>

  <div class="controls">
    <button id="btn-alerts">Enable Alerts</button>
    <button id="btn-sound">Sound: ON</button>
  </div>

  <div class="card">
    <h3>XAUUSD 5-min Chart</h3>
    <div id="tv-xau" style="height:500px; margin-top:16px;"></div>
  </div>

  <div class="card">
    <h3>Signal History</h3>
    <table id="log">
      <thead><tr><th>Time</th><th>Price</th><th>Signal</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
new TradingView.widget({
  width: "100%",
  height: 500,
  symbol: "OANDA:XAUUSD",
  interval: "5",
  timezone: "Etc/UTC",
  theme: "dark",
  style: "1",
  locale: "en",
  enable_publishing: false,
  container_id: "tv-xau"
});
</script>

<script>
// ────────────────────────────────────────────────
// REAL-TIME XAUUSD DASHBOARD – Finnhub WebSocket
// ────────────────────────────────────────────────

const FINNHUB_KEY = 'YOUR_FINNHUB_KEY_HERE'; // ← REPLACE THIS WITH YOUR REAL KEY
const WS_URL = `wss://ws.finnhub.io?token=${FINNHUB_KEY}`;

let price = null;
let lastValidPrice = null;
let history = new Float64Array(300);
let hIdx = 0;
let hCount = 0;

let currentSignal = 'neutral';
let alertsOn = false;
let soundOn = true;
let lastAlert = 0;

const beep = new Audio('https://www.soundjay.com/buttons/beep-07.mp3');

const $ = id => document.getElementById(id);
const els = {
  price:    $('price'),
  cur:      $('cur'),
  high:     $('high'),
  low:      $('low'),
  change:   $('change'),
  adx:      $('adx'),
  atr:      $('atr'),
  rsi:      $('rsi'),
  ema20:    $('ema20'),
  macd:     $('macd'),
  buyTp:    $('buy-tp'),
  sellTp:   $('sell-tp'),
  signal:   $('signal'),
  status:   $('status'),
  size:     $('size')
};

const emaCache = {};

function set(el, v) { if (el && el.textContent !== v) el.textContent = v; }

function push(p) {
  history[hIdx] = p;
  hIdx = (hIdx + 1) % 300;
  hCount = Math.min(hCount + 1, 300);
}

function getEMA(period) {
  if (hCount < period) return null;
  const k = `e${period}`;
  if (!(k in emaCache)) {
    let s = 0, start = (hIdx - period + 300) % 300;
    for (let i = 0; i < period; i++) s += history[(start + i) % 300];
    emaCache[k] = s / period;
  }
  const alpha = 2 / (period + 1);
  emaCache[k] = price * alpha + emaCache[k] * (1 - alpha);
  return emaCache[k];
}

function getRSI() {
  if (hCount < 15) return null;
  let g = 0, l = 0, start = (hIdx - 15 + 300) % 300;
  for (let i = 0; i < 14; i++) {
    const a = (start + i) % 300;
    const b = (start + i + 1) % 300;
    const ch = history[b] - history[a];
    ch > 0 ? g += ch : l -= ch;
  }
  const ag = g / 14, al = l / 14 || 1e-6;
  return 100 - 100 / (1 + ag / al);
}

function getMACD() {
  const e12 = getEMA(12), e26 = getEMA(26);
  if (!e12 || !e26) return null;
  const line = e12 - e26;
  const sig = getEMA(9);
  if (!sig) return null;
  return { macd: line.toFixed(2), signal: sig.toFixed(2), hist: (line - sig).toFixed(2) };
}

function getATR() {
  if (hCount < 15) return 0;
  let sum = 0;
  for (let i = 1; i <= 14; i++) {
    const curr = history[(hIdx - i + 300) % 300];
    const prev = history[(hIdx - i - 1 + 300) % 300];
    sum += Math.abs(curr - prev);
  }
  return sum / 14;
}

function getADX() {
  if (hCount < 28) return null;
  let sumTR = 0;
  for (let i = 1; i <= 14; i++) {
    const curr = history[(hIdx - i + 300) % 300];
    const prev = history[(hIdx - i - 1 + 300) % 300];
    sumTR += Math.abs(curr - prev);
  }
  const atrP = sumTR / 14;
  return atrP > 1.2 ? 30 : atrP > 0.6 ? 22 : 15; // proxy
}

function updateSignal() {
  if (hCount < 50) return;

  const adx = getADX();
  const atr = getATR();
  const rsi = getRSI();
  const ema20 = getEMA(20);
  const macd = getMACD();

  set(els.adx,   adx   ? adx.toFixed(1)   : '—');
  set(els.atr,   atr.toFixed(2));
  set(els.rsi,   rsi   ? rsi.toFixed(2)   : '—');
  set(els.ema20, ema20 ? ema20.toFixed(2) : '—');
  set(els.macd,  macd  ? `${macd.macd} / ${macd.signal}` : '—');

  let score = 0;
  if (rsi < 35) score += 2;
  if (rsi > 65) score -= 2;
  if (price > ema20) score += 2; else score -= 2;
  if (macd) {
    if (parseFloat(macd.hist) > 0) score += 3;
    else if (parseFloat(macd.hist) < 0) score -= 3;
  }

  let mult = 1;
  if (adx !== null) {
    if (adx > 25) mult = 1;
    else if (adx >= 20) mult = 0.7;
    else mult = 0.3;
  }
  score = Math.round(score * mult);

  const newSig = score >= 8 ? 'buy' : score <= -8 ? 'sell' : 'neutral';

  if (newSig !== currentSignal) {
    currentSignal = newSig;
    els.signal.textContent = newSig.toUpperCase() + ' SIGNAL';
    els.signal.className = `signal ${newSig}`;

    if (newSig !== 'neutral') {
      const now = Date.now();
      if (now - lastAlert > 300000) {
        if (alertsOn) new Notification(`XAUUSD ${newSig.toUpperCase()} @ ${price.toFixed(2)}`);
        if (soundOn) beep.play().catch(() => {});
        lastAlert = now;
      }

      const tb = document.querySelector('#log tbody');
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${new Date().toLocaleTimeString()}</td><td>${price.toFixed(2)}</td><td>${newSig.toUpperCase()}</td>`;
      tb.appendChild(tr);
      if (tb.children.length > 20) tb.removeChild(tb.firstChild);
    }
  }

  const sl = 1.5 * atr;
  const tp = 3.0 * atr;
  set(els.buyTp,  newSig === 'buy'  ? `Buy TP +${tp.toFixed(2)} (${(price + tp).toFixed(2)}) SL -${sl.toFixed(2)} (${(price - sl).toFixed(2)})` : '—');
  set(els.sellTp, newSig === 'sell' ? `Sell TP -${tp.toFixed(2)} (${(price - tp).toFixed(2)}) SL +${sl.toFixed(2)} (${(price + sl).toFixed(2)})` : '—');
}

function calcSize() {
  const acc = Number($('acc')?.value) || 10000;
  const r = (Number($('risk')?.value) || 1) / 100;
  const atr = getATR() || 10;
  const risk$ = acc * r;
  const oz = risk$ / (1.5 * atr);
  els.size.textContent = `Risk $${risk$.toFixed(2)} → ~${oz.toFixed(2)} oz`;
}

// ── WebSocket Real-Time ─────────────────────────────────

let ws;
function connectWebSocket() {
  ws = new WebSocket(WS_URL);

  ws.onopen = () => {
    els.status.textContent = 'Connected • Subscribing to XAUUSD';
    ws.send(JSON.stringify({ 'type':'subscribe', 'symbol':'XAUUSD' }));
  };

  ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    if (msg.type === 'trade' && msg.data && msg.data.length > 0) {
      const trade = msg.data[0];
      const newPrice = trade.p;
      if (typeof newPrice !== 'number' || newPrice < 1000) return;

      if (price !== null && Math.abs(newPrice - price) < MIN_CHANGE) return;

      price = newPrice;
      lastValidPrice = price;
      push(price);

      const p2 = price.toFixed(2);
      set(els.price, p2);
      set(els.cur, p2);
      set(els.ts, new Date().toLocaleString());

      updateSignal();
    }
  };

  ws.onerror = (err) => {
    console.error('WebSocket error:', err);
    els.status.textContent = 'Connection lost – reconnecting...';
  };

  ws.onclose = () => {
    setTimeout(connectWebSocket, 5000);
  };
}

connectWebSocket();

// Controls
document.getElementById('btn-alerts').onclick = () => {
  Notification.requestPermission().then(p => {
    if (p === 'granted') alertsOn = true;
  });
  alert('Alerts ' + (alertsOn ? 'enabled' : 'requested'));
};

document.getElementById('btn-sound').onclick = e => {
  soundOn = !soundOn;
  e.target.textContent = 'Sound: ' + (soundOn ? 'ON' : 'OFF');
};
</script>
</body>
</html>

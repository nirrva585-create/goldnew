<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>XAUUSD Real-Time Tool</title>
  <style>
    :root {
      --bg: #0a0a0a;
      --card: #111111;
      --text: #e8e8e8;
      --gold: #ffd700;
      --border: #2a2a2a;
      --green: #00ff88;
      --red: #ff4444;
      --gray: #888888;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 16px;
      line-height: 1.5;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    header { text-align: center; margin-bottom: 20px; }
    h1 { color: var(--gold); font-size: 2.5rem; margin: 0; }
    #price { font-size: 4.5rem; font-weight: 800; text-align: center; margin: 20px 0; letter-spacing: -2px; }
    #status { text-align: center; font-size: 1.1rem; color: var(--gray); margin-bottom: 12px; }
    .signal {
      font-size: 3rem;
      font-weight: 900;
      text-align: center;
      padding: 24px;
      border-radius: 16px;
      margin: 0 auto 32px;
      max-width: 600px;
      border: 4px solid;
      transition: all 0.3s;
      text-transform: uppercase;
    }
    .buy  { color: var(--green); border-color: var(--green); background: rgba(0,255,136,0.1); }
    .sell { color: var(--red);   border-color: var(--red);   background: rgba(255,68,68,0.1); }
    .neutral { color: #aaa; border-color: #444; background: #111; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 24px; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
    }
    .card h3 { color: var(--gold); margin-bottom: 16px; font-size: 1.4rem; }
    .stat-row { display: flex; justify-content: space-between; margin: 12px 0; font-size: 1.15rem; }
    .stat-label { color: var(--gray); }
    .ai-insight {
      margin-top: 20px;
      padding: 14px;
      background: rgba(255,215,0,0.08);
      border: 1px solid var(--gold);
      border-radius: 10px;
      font-size: 1.05rem;
    }
    .ai-insight li { margin: 4px 0; list-style: none; }
    input, button {
      width: 100%;
      padding: 14px;
      margin: 12px 0;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #1a1a1a;
      color: white;
      font-size: 1.1rem;
    }
    button {
      background: var(--gold);
      color: black;
      font-weight: bold;
      cursor: pointer;
      border: none;
    }
    .controls { text-align: center; margin: 40px 0; }
    .controls button { padding: 14px 32px; font-size: 1.2rem; margin: 0 16px; }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>XAUUSD Real-Time</h1>
  </header>

  <div id="price">--.--</div>
  <div id="status">Connecting to live feed…</div>

  <div id="signal" class="signal neutral">NO SIGNAL</div>

  <div class="grid">
    <div class="card">
      <h3>Live Data</h3>
      <div class="stat-row"><span class="stat-label">Price</span><span><b id="cur">--</b></span></div>
      <div class="stat-row"><span class="stat-label">High / Low</span><span><b id="high">--</b> / <b id="low">--</b></span></div>
      <div class="stat-row"><span class="stat-label">Change %</span><span><b id="change">--</b></span></div>
    </div>

    <div class="card">
      <h3>Indicators</h3>
      <div class="stat-row"><span class="stat-label">ADX(14)</span><span><b id="adx">--</b></span></div>
      <div class="stat-row"><span class="stat-label">ATR(14)</span><span><b id="atr">--</b></span></div>
      <div class="stat-row"><span class="stat-label">RSI(14)</span><span><b id="rsi">--</b></span></div>
      <div class="stat-row"><span class="stat-label">EMA(20)</span><span><b id="ema20">--</b></span></div>
      <div class="stat-row"><span class="stat-label">MACD</span><span><b id="macd">--</b></span></div>
    </div>

    <div class="card">
      <h3>Trade Levels</h3>
      <div id="buy-tp" style="margin:16px 0; min-height:60px; font-size:1.3rem;">—</div>
      <div id="sell-tp" style="min-height:60px; font-size:1.3rem;">—</div>
    </div>

    <div class="card">
      <h3>Risk Calc</h3>
      <input id="acc" type="number" value="10000" placeholder="Account ($)">
      <input id="risk" type="number" value="1" step="0.1" placeholder="Risk %">
      <button onclick="calcSize()">Calc Size</button>
      <div id="size" style="margin-top:20px; font-weight:bold; font-size:1.3rem;">—</div>
    </div>
  </div>

  <div class="card" style="margin-top:32px;">
    <h3>AI Insight</h3>
    <ul id="ai-insight" class="ai-insight">
      <li>Analyzing…</li>
    </ul>
  </div>

  <div class="controls">
    <button id="btn-alerts">Enable Alerts</button>
    <button id="btn-sound">Sound: ON</button>
  </div>

  <div class="card">
    <h3>XAUUSD 5-min Chart</h3>
    <div id="tv-xau" style="height:500px; margin-top:16px;"></div>
  </div>

  <div class="card">
    <h3>Signal Log</h3>
    <table id="log">
      <thead><tr><th>Time</th><th>Price</th><th>Signal</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
new TradingView.widget({
  width: "100%",
  height: 500,
  symbol: "OANDA:XAUUSD",
  interval: "5",
  timezone: "Etc/UTC",
  theme: "dark",
  style: "1",
  locale: "en",
  enable_publishing: false,
  container_id: "tv-xau"
});
</script>

<script>
// ────────────────────────────────────────────────
// FULLY AUTOMATIC REAL-TIME XAUUSD TOOL – Fixed All Errors
// ────────────────────────────────────────────────

const PROXY = 'https://corsproxy.io/?';
const GOLD_URL = 'https://goldprice.org/live-gold-price.html';

const POLL_MS = 60000; // 60 seconds - fast & safe
const MIN_CHANGE = 0.4;

let price = null;
let lastValidPrice = null;
let history = new Float64Array(300);
let hIdx = 0;
let hCount = 0;

let currentSignal = 'neutral';
let alertsOn = false;
let soundOn = true;
let lastAlert = 0;

const beep = new Audio('https://www.soundjay.com/buttons/beep-07.mp3');

const $ = id => document.getElementById(id);
const els = {
  price:    $('price'),
  cur:      $('cur'),
  high:     $('high'),
  low:      $('low'),
  change:   $('change'),
  adx:      $('adx'),
  atr:      $('atr'),
  rsi:      $('rsi'),
  ema20:    $('ema20'),
  macd:     $('macd'),
  buyTp:    $('buy-tp'),
  sellTp:   $('sell-tp'),
  signal:   $('signal'),
  status:   $('status'),
  error:    $('error'),
  aiInsight:$('ai-insight'),
  size:     $('size')
};

const emaCache = {};

function set(el, v) { if (el && el.textContent !== v) el.textContent = v; }

function showErr(msg) {
  els.error.textContent = msg;
  els.error.style.display = 'block';
  els.status.textContent = 'Issue – using last price';
}

function hideErr() { els.error.style.display = 'none'; }

function push(p) {
  history[hIdx] = p;
  hIdx = (hIdx + 1) % 300;
  hCount = Math.min(hCount + 1, 300);
}

function getEMA(period) {
  if (hCount < period) return null;
  const k = `e${period}`;
  if (!(k in emaCache)) {
    let s = 0, start = (hIdx - period + 300) % 300;
    for (let i = 0; i < period; i++) s += history[(start + i) % 300];
    emaCache[k] = s / period;
  }
  const alpha = 2 / (period + 1);
  emaCache[k] = price * alpha + emaCache[k] * (1 - alpha);
  return emaCache[k];
}

function getRSI() {
  if (hCount < 15) return null;
  let g = 0, l = 0, start = (hIdx - 15 + 300) % 300;
  for (let i = 0; i < 14; i++) {
    const a = (start + i) % 300;
    const b = (start + i + 1) % 300;
    const ch = history[b] - history[a];
    ch > 0 ? g += ch : l -= ch;
  }
  const ag = g / 14, al = l / 14 || 1e-6;
  return 100 - 100 / (1 + ag / al);
}

function getMACD() {
  const e12 = getEMA(12), e26 = getEMA(26);
  if (!e12 || !e26) return null;
  const line = e12 - e26;
  const sig = getEMA(9);
  if (!sig) return null;
  return { macd: line.toFixed(2), signal: sig.toFixed(2), hist: (line - sig).toFixed(2) };
}

function getATR() {
  if (hCount < 15) return 0;
  let sum = 0;
  for (let i = 1; i <= 14; i++) {
    const curr = history[(hIdx - i + 300) % 300];
    const prev = history[(hIdx - i - 1 + 300) % 300];
    sum += Math.abs(curr - prev);
  }
  return sum / 14;
}

function getADX() {
  if (hCount < 28) return null;
  let sumTR = 0;
  for (let i = 1; i <= 14; i++) {
    const curr = history[(hIdx - i + 300) % 300];
    const prev = history[(hIdx - i - 1 + 300) % 300];
    sumTR += Math.abs(curr - prev);
  }
  const atrP = sumTR / 14;
  return atrP > 1.2 ? 30 : atrP > 0.6 ? 22 : 15;
}

function updateAIInsight() {
  if (hCount < 50) {
    els.aiInsight.innerHTML = '<li>Loading…</li>';
    return;
  }

  const adx = getADX() || 0;
  const rsi = getRSI() || 50;
  const ema20 = getEMA(20) || price;
  const hist = parseFloat(getMACD()?.hist || 0);

  let html = '';
  html += `<li>Trend: <strong>${adx > 25 ? 'Strong' : 'Weak'}</strong> (${adx})</li>`;
  html += `<li>Bias: <strong>${price > ema20 ? '↑ Bullish' : '↓ Bearish'}</strong></li>`;

  if (rsi < 35) html += '<li>Oversold → Bounce watch</li>';
  else if (rsi > 65) html += '<li>Overbought → Pullback risk</li>';

  html += hist > 0 ? '<li>MACD ↑ Bullish</li>' : hist < 0 ? '<li>MACD ↓ Bearish</li>' : '<li>MACD neutral</li>';

  if (currentSignal === 'buy') html += '<li><strong style="color:#00ff88">BULLISH – Long dips</strong></li>';
  else if (currentSignal === 'sell') html += '<li><strong style="color:#ff4444">BEARISH – Short rallies</strong></li>';
  else html += '<li><strong>NEUTRAL – Wait</strong></li>';

  els.aiInsight.innerHTML = html;
}

function updateSignal() {
  if (hCount < 50) return;

  const adx = getADX();
  const atr = getATR();
  const rsi = getRSI();
  const ema20 = getEMA(20);
  const macd = getMACD();

  set(els.adx, adx ? adx.toFixed(1) : '—');
  set(els.atr, atr.toFixed(2));
  set(els.rsi, rsi ? rsi.toFixed(2) : '—');
  set(els.ema20, ema20 ? ema20.toFixed(2) : '—');
  set(els.macd, macd ? `${macd.macd} / ${macd.signal}` : '—');

  let score = 0;
  if (rsi < 35) score += 2;
  if (rsi > 65) score -= 2;
  if (price > ema20) score += 2; else score -= 2;
  if (macd) {
    if (parseFloat(macd.hist) > 0) score += 3;
    else if (parseFloat(macd.hist) < 0) score -= 3;
  }

  let mult = 1;
  if (adx !== null) {
    if (adx > 25) mult = 1;
    else if (adx >= 20) mult = 0.7;
    else mult = 0.3;
  }
  score = Math.round(score * mult);

  const newSig = score >= 8 ? 'buy' : score <= -8 ? 'sell' : 'neutral';

  if (newSig !== currentSignal) {
    currentSignal = newSig;
    els.signal.textContent = newSig.toUpperCase() + ' SIGNAL';
    els.signal.className = `signal ${newSig}`;

    if (newSig !== 'neutral') {
      const now = Date.now();
      if (now - lastAlert > 300000) {
        if (alertsOn) new Notification(`XAUUSD ${newSig.toUpperCase()} @ ${price.toFixed(2)}`);
        if (soundOn) beep.play().catch(() => {});
        lastAlert = now;
      }

      const tb = document.querySelector('#log tbody');
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${new Date().toLocaleTimeString()}</td><td>${price.toFixed(2)}</td><td>${newSig.toUpperCase()}</td>`;
      tb.appendChild(tr);
      if (tb.children.length > 20) tb.removeChild(tb.firstChild);
    }
  }

  const sl = 1.5 * atr;
  const tp = 3.0 * atr;
  set(els.buyTp, newSig === 'buy' ? `Buy TP +${tp.toFixed(2)} (${(price + tp).toFixed(2)}) SL -${sl.toFixed(2)} (${(price - sl).toFixed(2)})` : '—');
  set(els.sellTp, newSig === 'sell' ? `Sell TP -${tp.toFixed(2)} (${(price - tp).toFixed(2)}) SL +${sl.toFixed(2)} (${(price + sl).toFixed(2)})` : '—');

  updateAIInsight();
}

function calcSize() {
  const acc = Number($('acc')?.value) || 10000;
  const r = (Number($('risk')?.value) || 1) / 100;
  const atr = getATR() || 10;
  const risk$ = acc * r;
  const oz = risk$ / (1.5 * atr);
  els.size.textContent = `Risk $${risk$.toFixed(2)} → ~${oz.toFixed(2)} oz`;
}

async function refresh() {
  try {
    hideErr();
    els.status.textContent = 'Fetching live gold price...';

    const proxyUrl = PROXY + encodeURIComponent(GOLD_URL);
    const res = await fetch(proxyUrl, { cache: 'no-cache' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const html = await res.text();

    // Parse price from goldprice.org pattern
    const priceMatch = html.match(/(\d{1,4}(?:,\d{3})*\.\d{2})/);
    if (!priceMatch || !priceMatch[1]) throw new Error('Price not found');

    const newPrice = parseFloat(priceMatch[1].replace(/,/g, ''));
    if (isNaN(newPrice) || newPrice < 1000) throw new Error('Invalid price');

    if (price !== null && Math.abs(newPrice - price) < MIN_CHANGE) return;

    price = newPrice;
    lastValidPrice = price;
    push(price);

    const p2 = price.toFixed(2);
    set(els.price, p2);
    set(els.cur, p2);
    set(els.ts, new Date().toLocaleString());

    set(els.high, '—');
    set(els.low, '—');
    set(els.change, '—');

    if (hCount >= 50) updateSignal();

    els.status.textContent = 'Live • Updated';
  } catch (err) {
    console.error(err);
    showErr('Fetch failed: ' + err.message + ' – retrying in 60s');
    if (lastValidPrice) {
      set(els.price, lastValidPrice.toFixed(2));
      set(els.cur, lastValidPrice.toFixed(2));
    }
  }
}

refresh();
setInterval(refresh, POLL_MS);

// Controls
document.getElementById('btn-alerts').onclick = () => {
  Notification.requestPermission().then(p => { if (p === 'granted') alertsOn = true; });
  alert('Alerts ' + (alertsOn ? 'enabled' : 'requested'));
};

document.getElementById('btn-sound').onclick = e => {
  soundOn = !soundOn;
  e.target.textContent = 'Sound: ' + (soundOn ? 'ON' : 'OFF');
};

function calcSize() {
  const acc = Number($('acc')?.value) || 10000;
  const r = (Number($('risk')?.value) || 1) / 100;
  const atr = getATR() || 10;
  const risk$ = acc * r;
  const oz = risk$ / (1.5 * atr);
  els.size.textContent = `Risk $${risk$.toFixed(2)} → ~${oz.toFixed(2)} oz`;
}
</script>
</body>
</html>
